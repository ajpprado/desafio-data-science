---
title: "Desafio Data Science"
author: "Antonio Prado"
date: "October 24, 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Análise do dataset

#### Carregando dados:

```{r}
bank_data <- read.csv("bank-full.csv", sep = ";")

```

#### Verificando as dimensões dos dados:
```{r}
dim(bank_data)
```

Pelo número de entradas, 45211, podemos perceber que esse banco de dados está relacionado com os dados após a terceira iteração do método CRISP-DM realizada no artigo "USING DATA MINING FOR BANK DIRECT MARKETING: AN APPLICATION OF THE CRISP-DM METHODOLOGY", disponível em <http://hdl.handle.net/1822/14838>. Nesse dataset, como descrito no arquivo "bank-names.txt", não há instâncias com atributos faltantes e alguns atributos foram suprimidos.

Vemos que o problema original é um problema de classificação com variáveis mistas, embora as questões específicas do desafio possam representar problemas diferentes.


## Preparação do ambiente

#### Instalando pacotes

Utilizamos a biblioteca caret para algumas tarefas básicas, bem como outras bibliotecas para treinamentos específicos:
```{r, eval=FALSE}
install.packages("caret")
install.packages("ggplot2")
install.packages("dplyr")
```

#### Carregando bibliotecas

```{r, message=FALSE}
library(caret)
library(ggplot2)
library(dplyr)
```

## Questões

#### 1. Qual profissão tem mais tendência a fazer um empréstimo? De qual tipo?

Pelo dataset, encontramos dois tipos diferentes de empréstimos, listados como variáveis categóricas (cada cliente possui ou não possui tal tipo de empréstimo). O primeiro deles, "housing", indica se o cliente possui empréstimo imobiliário, enquanto o segundo, "loan", indica se o cliente possui empréstimo pessoal.


Contagem de clientes por tipo de trabalho:
```{r}
ggplot(bank_data, aes(x=bank_data$job )) + geom_bar() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```
```{r}
plyr::count(bank_data, "job")
```

<!--
```{r}
has_loan_data  <- subset(bank_data, housing=="yes" | loan=="yes", select=c(job, housing, loan))
ggplot(has_loan_data, aes(x=has_loan_data$job )) + geom_bar() + theme(axis.text.x = element_text(angle = 60, hjust = 1))
```
-->
Contagem de clientes que possuem algum tipo de empréstimo:
```{r}
has_loan_data  <- subset(bank_data, housing=="yes" | loan=="yes", select=c(job, housing, loan))
ggplot(has_loan_data, aes(x=has_loan_data$job )) + geom_bar() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

```{r}
plyr::count(has_loan_data, "job")
```

Proporção de clientes que possuem algum tipo de empréstimo, para cada trabalho:
```{r calc-total-loan}
has_loan_data <- mutate(bank_data, any_loan = ifelse(loan=="yes", "yes", ifelse(housing=="yes", "yes", "no")))
ggplot(has_loan_data, aes(x=has_loan_data$job, fill = any_loan)) + 
    geom_bar(position = "fill") + theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

Mais especificamente, para os trabalhadores com maior proporção de empréstimos, temos:
```{r}
bc_loan_proportion = sum(has_loan_data$any_loan=="yes" & has_loan_data$job=="blue-collar") /
    sum(has_loan_data$job=="blue-collar")
bc_loan_proportion
```

Olhando para o tipo de empréstimos, temos:
```{r}
bc_loan_housing = sum(has_loan_data$housing=="yes" & has_loan_data$job=="blue-collar") /
    sum(has_loan_data$any_loan=="yes" & has_loan_data$job=="blue-collar")
bc_loan_housing
```

```{r}
bc_loan_loan = sum(has_loan_data$loan=="yes" & has_loan_data$job=="blue-collar") /
    sum(has_loan_data$any_loan=="yes" & has_loan_data$job=="blue-collar")
bc_loan_loan
```

Esses resultados nos mostram que, no espaço dos clientes do banco em questão, os chamados trabalhadores "blue-collar" são os que possuem maior tendência a possuírem empréstimos (78%), sendo que, dos que possuem algum empréstimo, aproximadamente 93% deles possuem um empréstimo imobiliário e 22% deles possuem um empréstimo pessoal.

#### 2. Fazendo uma relação entre número de contatos e sucesso da campanha quais são os pontos relevantes a serem observados?

Analisando os dados, considerando que o sucesso da campanha se refere à campanha atual, isto é, a variável y do dataset.
Fazendo uma contagem preliminar da freqência absoluta do número de contatos, nessa campanha e em campanhas anteriores:
```{r}
contacts_data <- bank_data[, c(13, 15, 17)]
contacts_campaign <- plyr::count(contacts_data, "campaign")
contacts_previous <- plyr::count(contacts_data, "previous")
plyr::count(contacts_data, "campaign")
plyr::count(contacts_data, "previous")
```


```{r}
range <- (1:10)
lista1 <- (1:10)
lista2 <- (1:10)
lista_campaign <- (1:10)
lista_previous <- (1:10)
for (x in range){
    lista1[x] <- sum(contacts_data$campaign==(5*x)-5 | contacts_data$campaign==(5*x)-4 | contacts_data$campaign==(5*x)-3 | contacts_data$campaign==(5*x)-2 | contacts_data$campaign==(5*x)-1)
    lista2[x] <- sum((contacts_data$campaign==(5*x)-5 | contacts_data$campaign==(5*x)-4 | contacts_data$campaign==(5*x)-3 | contacts_data$campaign==(5*x)-2 | contacts_data$campaign==(5*x)-2) & contacts_data$y=="yes")
    lista_campaign[x] <- lista2[x]/lista1[x]
}
for (x in range){
    lista1[x] <- sum((contacts_data$previous==(5*x)-5 | contacts_data$previous==(5*x)-4 | contacts_data$previous==(5*x)-3 | contacts_data$previous==(5*x)-2 | contacts_data$previous==(5*x)-1) & contacts_data$previous>=1)
    lista2[x] <- sum((contacts_data$previous==(5*x)-5 | contacts_data$previous==(5*x)-4 | contacts_data$previous==(5*x)-3 | contacts_data$previous==(5*x)-1 | contacts_data$previous==(5*x)-1) & contacts_data$y=="yes" & contacts_data$previous>=1)
    lista_previous[x] <- lista2[x]/lista1[x]
}

ggplot(data.frame(range),aes((range*5)-2.5,lista_campaign))+geom_bar(stat="identity") + xlim(0, 50) + labs(x = "Contatos Campanha", y = "Proporção Outcome 'Yes'")
ggplot(data.frame(range),aes((range*5)-2.5,lista_previous))+geom_bar(stat="identity") + xlim(0, 50) + labs(x = "Contatos Campanha Anterior", y = "Proporção Outcome 'Yes'")
```

Devido ao grande número de possíveis contatos, o que dificultava a análise, nos gráficos acima eles foram agrupados em compartimentos de tamanho cinco e calculada a proporção de sucesso de cada compartimento. No primeiro gráfico todos os clientes foram considerados. No segundo, apenas os que já haviam sido contactados anteriormente.
Podemos ver que a porporção de sucessos da campanha atual cai com o aumento do número de contatos. O que não quer dizer que haja uma relação causal nesse sentido, um possível cliente mais indeciso potencialmente pode receber mais ligações, mesmo que sua probabilidade de assinar o plano fosse baixa desde o início.
Para campanhas anteriores, o número de contatos não parece ter uma relação muito clara com o sucesso da campanha atual. Apesar disso, podemos perceber que a taxa de adesão da campanha atual, considerando os clientes que haviam sido contatados ateriormente, é significativamente maior (23%) que a taxa de adesão geral (11%):

```{r}
plyr::count(contacts_data$previous>=1)
plyr::count(contacts_data$previous>=1 & contacts_data$y=="yes")
1905 / 8257

plyr::count(contacts_data$campaign>=1)
plyr::count(contacts_data$campaign>=1 & contacts_data$y=="yes")
5289 / 45211
```

#### 3. Baseando-se nos resultados de adesão desta campanha qual o número médio e o máximo de ligações que você indica para otimizar a adesão?

Considerando os gráficos da questão anterior, que exibiam a taxa de sucesso da campanha considerando todos os clientes e apenas os contactados anteriormente, pudemos perceber que em ambos os casos a taxa de sucesso caía bastante para clientes com número de contatos acima de 15, 20. Considerando também que campanhas com maior número de ligações tendem a ser mais caras, eu indicaria um máximo de 15 ligações, e uma média entre 5 e 10 ligações para cada cliente.

#### 4. O resultado da campanha anterior tem relevância na campanha atual?

#### 5. Qual o fator determinante para que o banco exija um seguro de crédito?

#### 6. Quais são as características mais proeminentes de um cliente que possua empréstimo imobiliário?
